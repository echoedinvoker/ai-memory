Human:

File: /home/matt/dotfiles/nvim/.config/nvim/lua/ai-memory/python/graph/prompts/summary_prompt.py
```python
from langchain_core.prompts import ChatPromptTemplate


summarize_prompt = ChatPromptTemplate.from_template(
    template="""你是一個專業的對話摘要助手。你的任務是：
1. 分析用戶的最新問題
2. 從歷史對話中提取與最新問題相關的重要上下文
3. 識別最新問題中的關鍵字和核心意圖
4. 創建一個新的問題，整合相關歷史上下文和關鍵字

請忽略與最新問題無關的歷史對話。你的摘要應該簡潔但包含所有相關信息。

輸出格式為:
    用戶問題分析: ...
    相關歷史上下文: ...
    關鍵字與用戶核心意圖: ...
    整合後的新問題: ...

整合後的新問題請遵循以下規則:
1. 保留與問題相關的程式碼片段以讓後續 agent 更清楚問題點所在
2. 每個程式碼片段都需要告知其所在的檔案的絕對路徑，這非常重要，因為之後的 agent 必須知道檔案的絕對路徑才能使用工具讀取檔案內容進行回答

請開始對以下對話進行摘要：
{messages}""",
    variables=["messages"]
)
```

上面 prompt 服務的 node 是專門用來對對話進行摘要並生成新問題的, 但是目前遇到的問題是新問題的內容容易被省略過多資訊, 例如原本對話中有某些檔案的絕對路徑, 這對之後的 agent 使用 tool 查詢檔案內容是非常重要的, 但是在新問題中卻很容易沒有提及, 或者是有些 codes 的片段對於問題點的定位是非常重要的, 但是在新問題中也很容易被省略掉, 這樣對於之後的 agent 來說是非常不友好的, 我想讓這個 node 的 agent 能夠意識到自己輸出的新問題, 對於後面 agent 來說是非常重要的, 重要的資訊不應該隨便省略掉必須非常謹慎的處理, 這樣才能保證整個對話的質量。請修改 template 內容已達成我的需求, 謝謝

AI:
我理解你的需求是要改進對話摘要助手的提示模板，使其在生成新問題時保留重要的上下文信息，特別是檔案的絕對路徑和關鍵程式碼片段。這些信息對於後續的agent使用工具查詢檔案內容非常重要。讓我來幫你修改這個模板。

首先，我來查看你提供的原始模板文件：根據你的需求，我將修改模板，強調保留檔案絕對路徑和關鍵程式碼片段的重要性，並使摘要助手更加謹慎地處理這些關鍵信息。以下是修改後的模板：

```python
from langchain_core.prompts import ChatPromptTemplate


summarize_prompt = ChatPromptTemplate.from_template(
    template="""你是一個專業的對話摘要助手，負責為後續AI助手準備完整且精確的問題上下文。你的任務是：
1. 分析用戶的最新問題
2. 從歷史對話中提取與最新問題相關的重要上下文
3. 識別最新問題中的關鍵字和核心意圖
4. 創建一個新的問題，整合相關歷史上下文和關鍵字

請忽略與最新問題無關的歷史對話。你的摘要應該簡潔但必須包含所有相關信息。

【重要提示】：你的輸出將直接影響後續AI助手的回答質量。後續AI助手將依賴你提供的信息來使用工具查詢檔案內容和理解問題上下文。如果你省略了關鍵信息，後續AI助手將無法正確回答問題。

輸出格式為:
    用戶問題分析: ...
    相關歷史上下文: ...
    關鍵字與用戶核心意圖: ...
    整合後的新問題: ...

整合後的新問題必須嚴格遵循以下規則:
1. 【絕對必要】保留所有檔案的絕對路徑，格式為：`/完整/絕對/路徑/到/檔案.副檔名`。這些路徑對後續AI助手使用工具讀取檔案內容至關重要。
2. 【絕對必要】保留所有與問題相關的程式碼片段，並明確標註其所屬的檔案絕對路徑。
3. 【絕對必要】保留所有錯誤訊息、堆疊追蹤或日誌輸出，這些對於問題診斷至關重要。
4. 【絕對必要】保留所有用戶提到的特定變數名稱、函數名稱、類別名稱和API名稱。
5. 整合後的新問題應該是完整的，即使它比原始問題稍長也沒關係，完整性比簡潔性更重要。

檔案路徑和程式碼處理指南:
- 當看到類似 `/home/user/project/file.py` 的路徑時，必須完整保留，不可簡化或省略。
- 當看到程式碼片段時，必須標明其所屬檔案的絕對路徑，例如：
  "檔案：/home/user/project/file.py
  ```python
  def example():
      return True
  ```"
- 如果原始問題中提到多個檔案，必須保留所有檔案的路徑和相關程式碼片段。

請開始對以下對話進行摘要，記住：寧可詳細也不要遺漏關鍵信息：
{messages}""",
    variables=["messages"]
)
```

### 解決方案概述

我對原始模板進行了以下關鍵改進：

1. **強調摘要助手的責任**：明確指出摘要助手的輸出將直接影響後續AI助手的回答質量。

2. **添加"重要提示"部分**：強調如果省略關鍵信息，後續AI助手將無法正確回答問題。

3. **強化規則描述**：
   - 使用【絕對必要】標記來強調最重要的規則
   - 明確要求保留所有檔案的絕對路徑
   - 要求保留所有與問題相關的程式碼片段
   - 要求保留所有錯誤訊息、堆疊追蹤或日誌輸出
   - 要求保留所有特定的變數名稱、函數名稱等

4. **添加檔案路徑和程式碼處理指南**：
   - 提供具體的檔案路徑格式示例
   - 提供程式碼片段與檔案路徑關聯的格式示例
   - 強調必須處理多檔案情況

5. **強調完整性優先**：明確指出完整性比簡潔性更重要，即使新問題比原始問題稍長也沒關係。

6. **結尾提醒**：添加"寧可詳細也不要遺漏關鍵信息"的提醒。

這些修改應該能夠使摘要助手更加謹慎地處理檔案路徑和程式碼片段等關鍵信息，確保後續的agent能夠獲得足夠的上下文來正確回答問題。

### 使用說明

你只需要將修改後的模板內容替換到 `/home/matt/dotfiles/nvim/.config/nvim/lua/ai-memory/python/graph/prompts/summary_prompt.py` 文件中即可。模板的基本結構和變量保持不變，只是增強了指導語和規則的描述。

### 進一步改進建議

1. **考慮添加示例**：如果摘要助手仍然不能很好地保留關鍵信息，可以考慮在模板中添加一個好的摘要示例。

2. **添加評估機制**：可以考慮讓摘要助手在生成摘要後，自我評估是否保留了所有關鍵信息，特別是檔案路徑和程式碼片段。

3. **調整輸出格式**：可以考慮在輸出格式中添加專門的部分來列出所有檔案路徑和程式碼片段，確保這些信息不會被遺漏。

4. **考慮使用結構化輸出**：如果你的系統支持，可以考慮使用JSON等結構化格式來輸出摘要，這樣可以更好地確保關鍵信息不會被省略。

Human:

